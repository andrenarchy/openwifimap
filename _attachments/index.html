<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.css" />
        <link rel="stylesheet" href="http://www.openlayers.org/api/theme/default/style.css" />
        <link rel="stylesheet" href="style.css" />
        <script src="http://code.jquery.com/jquery-1.8.2.js"></script>
        <script>
            $(document).bind("mobileinit", function(){
                $.mobile.hashListeningEnabled = false;
                $.mobile.pushStateEnabled = false;
            });
        </script>
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.js"></script>
        <script src="http://raw.github.com/dreamerslab/jquery.actual/master/jquery.actual.js"></script>
        <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
        <script>
            // this function is free software, Copyright (c) 2011, Kin Blas
            // see https://github.com/jblas/jquery-mobile-plugins/blob/master/page-params/jqm.page.params.js
            function queryStringToObject( qstr )
            {
                var result = {},
                nvPairs = ( ( qstr || "" ).replace( /^\?/, "" ).split( /&/ ) ),
                i, pair, n, v;

                for ( i = 0; i < nvPairs.length; i++ ) {
                    var pstr = nvPairs[ i ];
                    if ( pstr ) {
                        pair = pstr.split( /=/ );
                        n = pair[ 0 ];
                        v = pair[ 1 ];
                        if ( result[ n ] === undefined ) {
                            result[ n ] = v;
                            } else {
                            if ( typeof result[ n ] !== "object" ) {
                                result[ n ] = [ result[ n ] ];
                            }
                            result[ n ].push( v );
                        }
                    }
                }

                return result;
            }

            function parseHashSearchUrl(url) {
                var loc = $.mobile.path.parseUrl( url );
                var ret = {
                    hrefnosearch: loc.hrefNoSearch,
                    hash: loc.hash.replace( /^#/, ""), 
                    search: loc.search
                };
                if (ret.hash) {
                    loc = $.mobile.path.parseUrl( ret.hash );
                    ret.hash = loc.pathname;
                    ret.search = loc.search;
                }
                return ret;
            }

            var firstPage = true;
            var ignoreNextHashChange = false;
            var defaultPage = "mappage";
            $( document ).bind( "pagebeforechange", function( e, data ) {
                var hs;
                if (firstPage) {
                    hs = parseHashSearchUrl(window.location.href);
                } else if (typeof data.toPage === "string") {
                    hs = parseHashSearchUrl( data.toPage );
                } else {
                    return;
                }

                firstPage=false;
                if (!data.options.dataUrl) {
                    data.options.dataUrl = data.toPage;
                }

                data.toPage = hs.hrefnosearch + "#" + hs.hash;
                if (hs.search) {
                    data.options.pageData = queryStringToObject( hs.search );
                }

                $.mobile.activePageData = (data && data.options && data.options.pageData)
                    ? data.options.pageData
                    : null;
                ignoreNextHashChange = true;
            });
            
            $( window ).bind( "hashchange", function( e ) {
                if (!ignoreNextHashChange) {
                    $.mobile.changePage( $.mobile.path.parseLocation().hash , { 
                        allowSamePageTransition: true,
                        transition: "none"
                    });
                }
                ignoreNextHashChange = false;
            });

            var map;
            var markers;
            var position;
            var nodes = { };
            var icon;
            var epsg4326 = new OpenLayers.Projection("EPSG:4326");

            function handleMove() {
                $.ajax({
                    url: '_spatial/nodes',
                    dataType: 'json',
                    data: {
                        "bbox": map.getExtent().transform(map.getProjectionObject(), epsg4326).toBBOX()
                    },
                    success: function(data){
                        if (data.rows && $.isArray(data.rows)) {
                            // store nodes in object 'nodes'
                            data.rows.forEach( function(row) {
                                if (row.id && row.geometry && row.geometry.coordinates && row.value) {
                                    lonlat = new OpenLayers.LonLat.fromArray(row.geometry.coordinates).transform(epsg4326, map.getProjectionObject());
                                    if (nodes.hasOwnProperty(row.id)) {
                                        markers.removeMarker(nodes[row.id].marker);
                                    } 
                                    nodes[row.id] = {
                                        value: row.value,
                                        marker: new OpenLayers.Marker(lonlat, icon.clone())
                                    };
                                    markers.addMarker( nodes[row.id].marker );
                                }
                            });
                            // TODO: find neighbours that are not yet in 'nodes'
                        }
                    },
                    error: function(jqXHR, textstatus, errorThrown) {
                        console.log(textstatus);
                    }
                });
            }

            function initMap() {
                // create map
                map = new OpenLayers.Map('map');
                map.addLayer(new OpenLayers.Layer.OSM());
                markers = new OpenLayers.Layer.Markers( "Markers" );
                map.addLayer(markers);
                var size = new OpenLayers.Size(21,25);
                var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
                icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
                map.zoomToMaxExtent();
                map.events.register('moveend', map, handleMove);
            }

            // fix height of content
            function fixContentHeight(newPageID) {
                var currentPageID = $.mobile.activePage == null ? defaultPage : $.mobile.activePage.attr('id'),
                footer = $("#" + currentPageID + " > div[data-role='footer']"),
                header = $("#" + currentPageID + " > div[data-role='header']"),
                content = $("#" + currentPageID + " > div[data-role='content']"),
                viewHeight = $(window).height(),
                contentHeight = viewHeight - header.actual('outerHeight') - footer.actual('outerHeight');
                if (content.actual('outerHeight') + header.actual('outerHeight') + footer.actual('outerHeight') !== viewHeight) {
                    contentHeight -= (content.actual('outerHeight') - content.actual('height') /*+1*/ );
                    content.height(contentHeight);
                }
            }

            function fixMap() {
                fixContentHeight();
                if (window.map && window.map instanceof OpenLayers.Map) {
                    map.updateSize();
                } else {
                    initMap();
                    getPosition();
                }
            }

            function showPosition(pos) {
                position = pos;
                var lonlat = new OpenLayers.LonLat(pos.coords.longitude, pos.coords.latitude)
                  .transform( new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject() );
                map.setCenter(lonlat, 13);
            }

            function showPositionHigh(pos) {
                showPosition(pos);
            }

            function showPositionLow(pos) {
                showPosition(pos);
                navigator.geolocation.getCurrentPosition(showPositionHigh, null, {timeout: 10000, maximumAge:1000, enableHighAccuracy: true});
            }

            function getPosition() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPositionLow, null, {timeout: 5000, enableHighAccuracy: false});
                }
            }

            //fix the content height AFTER jQuery Mobile has rendered the map page
            $('#mappage').live('pageshow', fixMap);
            $(window).bind("orientationchange resize pagebeforeshow pageshow", fixContentHeight);
            $(document).ready( function() {
                $.mobile.defaultHomeScroll=0;
            });

            $(document).live("pagebeforeshow", function (e, data) {
                console.log( $.mobile.activePageData );
            });
        </script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, target-densitydpi=device-dpi">
    </head>

    <body>
        <div data-role="page" data-theme="b" id="mappage">
             <div data-role="header" id="header">
                <h1>OpenWiFiMap</h1>
            </div>
            <div data-role="content" id="content">
                <div id="map"></div>
            </div>
            <div data-role="footer" id="footer">
                <div class="ui-grid-b">
                    <div class="ui-block-a"></div>
                    <div class="ui-block-b"></div>
                    <div class="ui-block-c"><a href="#listpage?bbox=40,2,1&bla=12" data-transition="slide"><button type="button" data-theme="b" data-icon="arrow-r" data-iconpos="right">Show list</button></a></div>
                </div>
            </div>
        </div>
        
        <div data-role="page" id="listpage" data-theme="b">
             <div data-role="header">
                <h1>OpenWiFiMap &ndash; List</h1>
            </div>
            <div data-role="content">       
                <ul data-role="listview">
                    <li><a href="#detailpage" data-transition="slide">
                        <h3>liebknecht</h3>
                        <p>#freifunk #accesspoint #mesh #olsr</p>
                    </a></li>
                    <li><a href="http://www.google.de" data-transition="slide">
                        <h3>monument1</h3>
                        <p>#freifunk #mesh #olsr</p>
                    </a></li>
                </ul>
            </div>
            <div data-role="footer">
                <div class="ui-grid-b">
                    <div class="ui-block-a"><a href="#mappage" data-transition="slide" data-direction="reverse"><button type="button" data-theme="b" data-icon="arrow-l" data-iconpos="left">Show map</button></a></div>
                    <div class="ui-block-b"></div>
                    <div class="ui-block-c"></div>
                </div>
            </div>
        </div>
        
        <div data-role="page" id="detailpage" data-theme="b">
             <div data-role="header">
                <h1>OpenWiFiMap &ndash; Details</h1>
            </div>
            <div data-role="content">       
                <p>I need some serious detailed content here!</p>
            </div>
            <div data-role="footer">
                <div class="ui-grid-b">
                    <div class="ui-block-a"><a href="#listpage" data-transition="slide" data-direction="reverse"><button type="button" data-theme="b" data-icon="arrow-l" data-iconpos="left">Show list</button></a></div>
                    <div class="ui-block-b"></div>
                    <div class="ui-block-c"></div>
                </div>
            </div>
        </div>
    </body>
</html>
